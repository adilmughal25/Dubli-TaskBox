'use strict';

var uuid = require('node-uuid');

function generate (userId) {
  // intentionally use v1 so we can get timestamp back out
  var uid = uuid.v1().replace(/-/g, '');
  var hexUser = userId.toString(16);
  return uid + hexUser;
}

function extract (subId) {
  // get user id
  var userIdHex = subId.slice(32);
  var userId = parseInt(userIdHex, 16);

  // get timestamp from uuid
  var uuidNoHyphen = subId.slice(0, 32);
  var uuidWithHyphens = _addHyphens(uuidNoHyphen.slice(0, 32));
  var dateOfUuid = _getDateFromUuid(uuidWithHyphens);

  return {
    userId: userId,
    date: dateOfUuid
  };
}

function _addHyphens (str) {
  return [str.slice(0, 8), '-', str.slice(8, 12), '-', str.slice(12, 16), '-', str.slice(16, 20), '-', str.slice(20)].join('');
}

function _getDateFromUuid (uuidv1) {
  var uuidArr = uuidv1.split('-');
  var hexTime = [
    uuidArr[2].substring(1),
    uuidArr[1],
    uuidArr[0]
  ].join('');
  var timeNano = parseInt(hexTime, 16) - 122192928000000000;
  var timeMillis = Math.floor(timeNano / 10000);
  return new Date(timeMillis);
}

module.exports = {
  generate: generate,
  extract: extract
};
