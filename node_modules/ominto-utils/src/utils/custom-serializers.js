'use strict';

// CUSTOM BUNYAN SERIALIZERS
module.exports = {
  err: errSerializer
};

function errSerializer (err) {
  if (!err || !err.stack) {
    return err;
  }
  var stack = err.stack.split('\n');

  stack = stack.reduce(function (list, line) {
    // Strip out certain lines.
    if (_isNodeInternal(line)) {
      return list;
    }
    list.push(line);
    return list;
  }, []);

  var obj = {
    message: err.message,
    name: err.name,
    stack: stack.join('\n')
  };

  Object.keys(err).forEach(function (key) {
    obj[key] = err[key];
  });

  return obj;
}

/*
 * Checks if stack trace line is an internal node function
 * Or a useless lines that shows up all the time
 */
function _isNodeInternal (line) {
  return ~line.indexOf('(timers.js:') ||
  ~line.indexOf('(node.js:') ||
  ~line.indexOf('(module.js:') ||
  ~line.indexOf('_stream_readable.js') ||
  ~line.indexOf('process._tickDomainCallback') ||
  ~line.indexOf('GeneratorFunctionPrototype.next (native)') ||
  ~line.indexOf('GeneratorFunctionPrototype.throw (native)') ||
  // co
  ~line.indexOf('/co/index.js') ||
  // koa-router
  ~line.indexOf('Object.dispatch') ||
  // bluebird
  ~line.indexOf('Promise._settlePromise') ||
  ~line.indexOf('Async._drainQueues') ||
  ~line.indexOf('Immediate.Async.drainQueues') ||
  false;
}
