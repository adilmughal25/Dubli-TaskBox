'use strict';

const _ = require('lodash');
const ALL_AVAILABLE_GATEWAYS = ['paypal', 'payu', 'dwolla', 'stripe', 'infiplanet','novalnet', 'coinbase', 'payoneer', 'ominto', 'paytm'];
let dataClient;
const DIRECTIONS = ['in', 'out'];

const getPaymentGateways = (region, currency) => dataGet('/getAvailablePaymentOptions/' + region + '/' + currency + '/');
const getTransactionGateways = (region, currency) => dataGet('/getAvailableTransactionOptions/' + region + '/' + currency + '/');

const dataGet = url => {
  return function (ctx) {
    return dataClient.get(url, null, ctx);
  };
};

module.exports = function init (config) {
  dataClient = require('../utils/rest-client')(config.data_api, false);
  return {
    determineAvailableGateways: determineAvailableGateways,
    checkIfTransactionSupported: checkIfTransactionSupported
  };
};

function * determineAvailableGateways (region, currency, direction, ctx) {
  if (_.indexOf(DIRECTIONS, direction.toLowerCase()) === -1) {
    return [];
  }
  let gateways = direction === 'in' ? yield getPaymentGateways(region, currency)(ctx) : yield getTransactionGateways(region, currency)(ctx);
  return gateways.body;
}

function * checkIfTransactionSupported (region, currency, direction, gateway, ctx) {
  if (_.indexOf(ALL_AVAILABLE_GATEWAYS, gateway.toLowerCase()) === -1) {
    return false;
  }
  let actionAllowed;
  let availableGateways = yield determineAvailableGateways(region, currency, direction, ctx);
  actionAllowed = _.indexOf(availableGateways, gateway.toLowerCase()) > -1;
  return actionAllowed;
}
